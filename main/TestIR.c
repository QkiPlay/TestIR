#include "freertos/FreeRTOS.h"
#include "freertos/task.h"

#include "src/wifi.h"
#include "src/MLX90640_I2C_Driver.h"
#include "src/MLX90640_API.h"

#include "src/i2c_general.h"

#define MLXADDR 0x33

static const char *TAG = "MAIN_TEST";

/// @brief 
/// @param image 
/// @return 0 - No detection
/// @return 1 - Object detected
int MLX90640_Is_Object(int16_t *image){
	int64_t sum = 0;

	for (int i = 0; i < 768; i++) sum += image[i];
	int64_t avg = sum/768;
	for (int i = 0; i < 768; i++) {
		if (image[i] > avg+10){
			return 1;
		}
	}
return 0;
}

int NUC[] = {-41.540000915527344, -42.040000915527344, -39.779998779296875, -43.540000915527344, -42.47999954223633, -42.58000183105469, -40.2599983215332, -44.540000915527344, -43.08000183105469, -43.459999084472656, -41.060001373291016, -45.31999969482422, -42.959999084472656, -43.84000015258789, -40.779998779296875, -45.08000183105469, -41.779998779296875, -44.099998474121094, -40.5, -45.2400016784668, -42.13999938964844, -43.65999984741211, -40.400001525878906, -45.15999984741211, -40.91999816894531, -43.63999938964844, -39.560001373291016, -44.68000030517578, -41.279998779296875, -43.15999984741211, -38.060001373291016, -44.959999084472656, -43.68000030517578, -43.439998626708984, -44.68000030517578, -43.97999954223633, -44.560001373291016, -44.220001220703125, -45.20000076293945, -44.81999969482422, -45.099998474121094, -44.70000076293945, -45.79999923706055, -45.65999984741211, -45.040000915527344, -45.2400016784668, -45.279998779296875, -45.41999816894531, -43.560001373291016, -45.31999969482422, -45.20000076293945, -45.279998779296875, -44.0, -44.7599983215332, -44.7400016784668, -45.20000076293945, -42.7400016784668, -44.560001373291016, -43.79999923706055, -44.779998779296875, -42.68000030517578, -44.08000183105469, -42.36000061035156, -44.84000015258789, -42.20000076293945, -42.52000045776367, -40.70000076293945, -44.2599983215332, -43.15999984741211, -43.2599983215332, -41.02000045776367, -45.29999923706055, -43.279998779296875, -44.18000030517578, -41.34000015258789, -45.70000076293945, -43.65999984741211, -44.79999923706055, -41.31999969482422, -45.81999969482422, -42.939998626708984, -44.599998474121094, -40.81999969482422, -46.040000915527344, -42.2599983215332, -44.459999084472656, -40.560001373291016, -45.81999969482422, -41.560001373291016, -44.040000915527344, -39.959999084472656, -45.060001373291016, -41.779998779296875, -43.720001220703125, -38.900001525878906, -45.79999923706055, -44.060001373291016, -43.7400016784668, -45.34000015258789, -44.619998931884766, -44.81999969482422, -44.63999938964844, -45.5, -45.599998474121094, -45.220001220703125, -45.31999969482422, -45.939998626708984, -45.86000061035156, -45.34000015258789, -45.720001220703125, -45.81999969482422, -46.08000183105469, -44.65999984741211, -45.560001373291016, -45.18000030517578, -46.060001373291016, -43.959999084472656, -45.52000045776367, -44.959999084472656, -45.86000061035156, -43.060001373291016, -44.900001525878906, -44.119998931884766, -45.119998931884766, -43.619998931884766, -44.599998474121094, -43.20000076293945, -45.7400016784668, -41.34000015258789, -42.7599983215332, -41.29999923706055, -44.91999816894531, -42.47999954223633, -43.439998626708984, -41.34000015258789, -45.380001068115234, -42.91999816894531, -44.599998474121094, -42.29999923706055, -46.040000915527344, -43.29999923706055, -44.939998626708984, -42.02000045776367, -46.18000030517578, -42.2400016784668, -44.84000015258789, -41.119998931884766, -45.86000061035156, -42.63999938964844, -44.599998474121094, -41.380001068115234, -45.959999084472656, -41.5, -44.439998626708984, -40.86000061035156, -45.279998779296875, -42.13999938964844, -43.939998626708984, -39.52000045776367, -45.959999084472656, -43.29999923706055, -44.599998474121094, -46.040000915527344, -45.380001068115234, -44.7400016784668, -44.7599983215332, -45.86000061035156, -45.84000015258789, -44.86000061035156, -45.84000015258789, -46.63999938964844, -46.31999969482422, -45.2599983215332, -46.13999938964844, -46.15999984741211, -46.81999969482422, -44.040000915527344, -46.20000076293945, -45.68000030517578, -46.220001220703125, -44.34000015258789, -45.560001373291016, -45.720001220703125, -45.880001068115234, -43.380001068115234, -45.86000061035156, -44.779998779296875, -45.47999954223633, -43.97999954223633, -45.15999984741211, -43.720001220703125, -46.18000030517578, -42.7599983215332, -43.02000045776367, -41.459999084472656, -45.13999938964844, -44.400001525878906, -43.84000015258789, -42.040000915527344, -46.31999969482422, -44.2400016784668, -44.29999923706055, -42.15999984741211, -46.2400016784668, -44.400001525878906, -44.79999923706055, -42.279998779296875, -46.540000915527344, -43.2400016784668, -44.7599983215332, -41.84000015258789, -46.58000183105469, -42.380001068115234, -44.97999954223633, -41.34000015258789, -46.279998779296875, -42.220001220703125, -44.900001525878906, -40.97999954223633, -46.0, -42.31999969482422, -44.29999923706055, -39.459999084472656, -46.29999923706055, -44.7599983215332, -45.02000045776367, -46.41999816894531, -45.63999938964844, -46.58000183105469, -45.70000076293945, -46.79999923706055, -46.880001068115234, -46.459999084472656, -46.099998474121094, -47.15999984741211, -46.52000045776367, -46.560001373291016, -46.2599983215332, -47.040000915527344, -46.91999816894531, -45.18000030517578, -46.2599983215332, -46.41999816894531, -46.79999923706055, -44.439998626708984, -46.400001525878906, -45.91999816894531, -46.619998931884766, -44.02000045776367, -46.18000030517578, -45.279998779296875, -46.119998931884766, -44.119998931884766, -45.5, -43.84000015258789, -46.540000915527344, -43.36000061035156, -43.47999954223633, -41.7599983215332, -45.7400016784668, -44.02000045776367, -44.439998626708984, -42.099998474121094, -46.5, -44.380001068115234, -44.91999816894531, -42.70000076293945, -46.779998779296875, -44.81999969482422, -45.31999969482422, -42.84000015258789, -47.13999938964844, -43.619998931884766, -45.279998779296875, -42.65999984741211, -46.68000030517578, -43.619998931884766, -44.900001525878906, -41.70000076293945, -46.7599983215332, -42.5, -45.13999938964844, -41.0, -46.279998779296875, -42.599998474121094, -44.68000030517578, -39.79999923706055, -46.220001220703125, -45.47999954223633, -45.560001373291016, -46.97999954223633, -46.7599983215332, -46.15999984741211, -46.18000030517578, -47.08000183105469, -47.220001220703125, -46.939998626708984, -46.7400016784668, -47.63999938964844, -47.5, -46.959999084472656, -47.2599983215332, -47.65999984741211, -47.63999938964844, -45.7400016784668, -46.939998626708984, -47.29999923706055, -47.18000030517578, -45.70000076293945, -46.47999954223633, -46.52000045776367, -47.13999938964844, -44.47999954223633, -46.560001373291016, -45.7400016784668, -46.79999923706055, -44.47999954223633, -46.0, -44.15999984741211, -46.720001220703125, -42.65999984741211, -43.15999984741211, -41.79999923706055, -45.47999954223633, -43.5, -44.29999923706055, -42.540000915527344, -46.380001068115234, -43.880001068115234, -45.099998474121094, -43.220001220703125, -46.86000061035156, -44.20000076293945, -45.220001220703125, -42.68000030517578, -46.939998626708984, -43.58000183105469, -45.599998474121094, -42.7599983215332, -46.959999084472656, -43.84000015258789, -45.31999969482422, -42.08000183105469, -46.7599983215332, -43.099998474121094, -45.02000045776367, -42.0, -46.41999816894531, -42.70000076293945, -44.2599983215332, -40.279998779296875, -46.560001373291016, -45.2400016784668, -45.31999969482422, -47.0, -46.459999084472656, -46.099998474121094, -46.34000015258789, -47.7599983215332, -47.2400016784668, -46.34000015258789, -47.08000183105469, -48.040000915527344, -47.880001068115234, -46.58000183105469, -47.20000076293945, -47.34000015258789, -47.84000015258789, -45.959999084472656, -47.36000061035156, -47.65999984741211, -47.7400016784668, -45.91999816894531, -46.880001068115234, -46.79999923706055, -47.41999816894531, -45.18000030517578, -46.65999984741211, -46.459999084472656, -47.20000076293945, -44.65999984741211, -46.15999984741211, -44.599998474121094, -47.13999938964844, -44.08000183105469, -43.380001068115234, -41.91999816894531, -45.7599983215332, -44.400001525878906, -44.7599983215332, -42.7599983215332, -46.7400016784668, -45.0, -45.599998474121094, -42.84000015258789, -47.5, -45.36000061035156, -45.31999969482422, -42.84000015258789, -47.29999923706055, -44.5, -45.81999969482422, -42.7599983215332, -47.31999969482422, -44.2599983215332, -45.400001525878906, -42.58000183105469, -47.18000030517578, -43.099998474121094, -45.2599983215332, -42.040000915527344, -46.63999938964844, -43.060001373291016, -44.79999923706055, -40.15999984741211, -46.70000076293945, -46.599998474121094, -46.31999969482422, -47.459999084472656, -47.36000061035156, -47.220001220703125, -47.220001220703125, -48.2400016784668, -47.86000061035156, -47.599998474121094, -47.65999984741211, -48.08000183105469, -48.2400016784668, -47.599998474121094, -47.380001068115234, -48.279998779296875, -48.41999816894531, -46.97999954223633, -47.58000183105469, -47.79999923706055, -48.2400016784668, -46.560001373291016, -47.439998626708984, -47.560001373291016, -47.97999954223633, -45.36000061035156, -47.2599983215332, -46.779998779296875, -47.36000061035156, -45.08000183105469, -46.41999816894531, -44.959999084472656, -47.400001525878906, -44.099998474121094, -43.400001525878906, -42.939998626708984, -45.81999969482422, -44.84000015258789, -44.47999954223633, -43.099998474121094, -46.560001373291016, -45.119998931884766, -45.439998626708984, -43.5, -46.939998626708984, -45.220001220703125, -45.84000015258789, -43.36000061035156, -47.380001068115234, -44.900001525878906, -45.91999816894531, -43.13999938964844, -47.41999816894531, -44.02000045776367, -45.560001373291016, -42.400001525878906, -47.119998931884766, -43.279998779296875, -45.2599983215332, -41.959999084472656, -46.79999923706055, -43.439998626708984, -45.099998474121094, -40.7400016784668, -47.18000030517578, -46.65999984741211, -46.65999984741211, -48.599998474121094, -47.5, -47.7400016784668, -47.58000183105469, -48.79999923706055, -48.08000183105469, -47.900001525878906, -48.02000045776367, -49.08000183105469, -48.540000915527344, -47.91999816894531, -48.2400016784668, -48.65999984741211, -48.439998626708984, -47.41999816894531, -48.15999984741211, -48.459999084472656, -48.65999984741211, -46.36000061035156, -48.060001373291016, -47.70000076293945, -47.959999084472656, -45.47999954223633, -47.58000183105469, -46.7599983215332, -47.68000030517578, -45.619998931884766, -46.779998779296875, -45.47999954223633, -48.15999984741211, -43.2599983215332, -43.08000183105469, -42.560001373291016, -45.619998931884766, -43.79999923706055, -44.459999084472656, -43.619998931884766, -46.65999984741211, -45.099998474121094, -45.36000061035156, -44.08000183105469, -47.220001220703125, -44.939998626708984, -45.79999923706055, -43.84000015258789, -47.5, -44.5, -46.060001373291016, -43.0, -47.36000061035156, -44.18000030517578, -45.41999816894531, -42.880001068115234, -47.400001525878906, -43.20000076293945, -45.08000183105469, -42.68000030517578, -47.099998474121094, -43.279998779296875, -44.79999923706055, -41.099998474121094, -47.18000030517578, -46.79999923706055, -46.540000915527344, -48.619998931884766, -47.560001373291016, -46.959999084472656, -47.459999084472656, -49.52000045776367, -48.5, -48.13999938964844, -48.560001373291016, -49.58000183105469, -49.34000015258789, -48.08000183105469, -48.560001373291016, -49.08000183105469, -49.34000015258789, -47.29999923706055, -48.58000183105469, -48.459999084472656, -49.099998474121094, -46.779998779296875, -48.20000076293945, -48.20000076293945, -48.65999984741211, -45.79999923706055, -47.599998474121094, -47.36000061035156, -48.5, -45.29999923706055, -47.08000183105469, -45.619998931884766, -48.380001068115234, -44.939998626708984, -43.47999954223633, -43.0, -45.619998931884766, -45.220001220703125, -44.2599983215332, -43.20000076293945, -46.63999938964844, -45.29999923706055, -45.7599983215332, -43.619998931884766, -47.52000045776367, -45.52000045776367, -45.79999923706055, -44.02000045776367, -47.58000183105469, -45.13999938964844, -46.0, -43.47999954223633, -47.720001220703125, -44.58000183105469, -45.560001373291016, -43.0, -47.220001220703125, -43.81999969482422, -45.060001373291016, -42.2599983215332, -46.5, -43.68000030517578, -44.97999954223633, -41.15999984741211, -46.939998626708984, -48.20000076293945, -47.599998474121094, -49.119998931884766, -48.060001373291016, -48.439998626708984, -47.7400016784668, -49.459999084472656, -48.7599983215332, -48.70000076293945, -49.18000030517578, -49.86000061035156, -49.63999938964844, -49.040000915527344, -49.220001220703125, -50.18000030517578, -49.540000915527344, -48.13999938964844, -48.97999954223633, -49.560001373291016, -49.41999816894531, -47.400001525878906, -48.41999816894531, -48.70000076293945, -49.0, -46.5, -47.70000076293945, -47.84000015258789, -47.91999816894531, -46.02000045776367, -47.2599983215332, -46.2400016784668, -48.220001220703125, -45.2400016784668, -43.34000015258789, -43.02000045776367, -45.720001220703125, -45.2400016784668, -44.63999938964844, -43.29999923706055, -47.040000915527344, -45.959999084472656, -46.08000183105469, -43.599998474121094, -47.540000915527344, -45.5, -46.099998474121094, -44.040000915527344, -48.040000915527344, -45.400001525878906, -45.97999954223633, -43.599998474121094, -47.81999969482422, -44.400001525878906, -45.400001525878906, -43.040000915527344, -47.459999084472656, -43.279998779296875, -44.959999084472656, -42.459999084472656, -46.880001068115234, -44.060001373291016, -44.84000015258789, -41.220001220703125, -46.65999984741211, -49.02000045776367, -47.65999984741211, -49.79999923706055, -48.7599983215332, -49.0, -48.65999984741211, -49.86000061035156, -49.81999969482422, -49.400001525878906, -49.58000183105469, -50.41999816894531, -50.0, -49.18000030517578, -49.84000015258789, -50.65999984741211, -50.20000076293945, -49.08000183105469, -49.619998931884766, -49.91999816894531, -50.119998931884766, -47.91999816894531, -49.02000045776367, -49.439998626708984, -49.58000183105469, -46.29999923706055, -48.540000915527344, -48.060001373291016, -48.65999984741211, -46.7400016784668, -47.79999923706055, -46.619998931884766, -48.31999969482422, -45.099998474121094, -43.18000030517578, -43.0, -45.619998931884766, -45.02000045776367, -44.720001220703125, -44.060001373291016, -46.97999954223633, -45.13999938964844, -46.08000183105469, -44.91999816894531, -47.7400016784668, -45.70000076293945, -45.63999938964844, -45.0, -47.7400016784668, -44.900001525878906, -45.880001068115234, -43.86000061035156, -47.7400016784668, -44.400001525878906, -45.47999954223633, -43.0, -47.15999984741211, -44.5, -44.84000015258789, -43.20000076293945, -46.63999938964844, -44.08000183105469, -44.34000015258789, -42.20000076293945, -46.41999816894531, -51.220001220703125, -49.58000183105469, -51.900001525878906, -50.900001525878906, -50.880001068115234, -50.70000076293945, -52.70000076293945, -51.599998474121094, -50.63999938964844, -51.959999084472656, -52.959999084472656, -52.560001373291016, -51.36000061035156, -51.5, -52.900001525878906, -52.220001220703125, -50.619998931884766, -51.47999954223633, -52.02000045776367, -52.15999984741211, -49.959999084472656, -51.2400016784668, -51.15999984741211, -51.68000030517578, -49.52000045776367, -50.31999969482422, -50.41999816894531, -51.15999984741211, -48.5, -49.619998931884766, -48.68000030517578, -50.619998931884766};

void app_main(	void)
{
    ESP_ERROR_CHECK(I2C_Init());
    MLX90640_I2CInit();
	nvs_init();
	wifi_connect();
	init_udp_socket();


    int status;
	uint16_t frame[834]; /*= (834*sizeof(uint16_t));*/
	int16_t	image[768]; /*= (768*sizeof(int16_t));*/

    MLX90640_SetResolution(MLXADDR, 0x00);
	MLX90640_SetRefreshRate(MLXADDR, 0x01);
	
	while (1) {
		status = MLX90640_GetFrameData(MLXADDR, frame);
		for (int i = 0; i < 768; i++) {
    		image[i] = (int16_t)frame[i];
			image[i] -= NUC[i];
		}
		int IsObject = MLX90640_Is_Object(image);
		if (IsObject == 1)
		{
			ESP_LOGI(TAG, "OBJECT DETECTED\n");
			send_image(image);
		}else ESP_LOGI(TAG, "NO OBJECT\n");
		
		vTaskDelay(1000 / portTICK_PERIOD_MS);
	}
}
